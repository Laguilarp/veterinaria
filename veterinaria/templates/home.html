{% extends "app_base_panel.html" %}
{% load static %}
{% block head %}
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
    <!-- Theme style -->
    <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
    <!-- summernote -->
    <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.min.css' %}">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

        var countAdmin = 0;
        var countEmple = 0;
        var countPersona = 0;
        var countMarcadas = 0;

        function ejecutar() {
            var totalPromises = [];

            function makeAjaxRequest(url, targetElement) {
                return new Promise(function (resolve, reject) {
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function (data) {
                            if (data.success) {
                                var total = parseInt(data.total);
                                var contador = 0;

                                function incrementCounter() {
                                    targetElement.textContent = contador;
                                    contador++;

                                    if (contador <= total) {
                                        var delay = 500;
                                        if (total <= 10) {
                                            delay = 500
                                        }

                                        if (total > 10 && total <= 20) {
                                            delay = 100
                                        }

                                        if (total > 20) {
                                            delay = 5
                                        }

                                        setTimeout(incrementCounter, delay);
                                    } else {
                                        resolve();
                                    }
                                }

                                incrementCounter();
                            } else {
                                targetElement.textContent = "0";
                                resolve();
                            }
                        },
                        error: function () {
                            reject("Error en la solicitud AJAX.");
                        }
                    });
                });
            }

            totalPromises.push(makeAjaxRequest("{% url 'administrativo:consultaPersonas' %}", document.getElementById('countPersonas')));
            totalPromises.push(makeAjaxRequest("{% url 'administrativo:consultaAdministrativos' %}", document.getElementById('countAdmin')));

            Promise.all(totalPromises)
                .then(function () {
                    // Todas las solicitudes AJAX se han completado
                    // Puedes agregar cualquier otra lógica que necesites aquí
                })
                .catch(function (error) {
                    console.error(error);
                    alert("Ocurrió un error en alguna de las solicitudes AJAX.");
                });
        }


        window.onload = function () {
            ejecutar();
        }

        function consultaAdministrativos() {
            if (parseInt(countAdmin) == 1) {
                $.ajax({
                    url: "{% url 'administrativo:consultaAdministrativos' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function (data) {
                        if (data.success) {
                            document.getElementById('countAdmin').textContent = data.total;
                        } else {
                            document.getElementById('countAdmin').textContent = "0";
                        }
                    },
                    error: function () {
                        toast_error("Error en la solicitud AJAX.");
                    }
                });
            }
        }

        function consultaEmpleados() {
            if (parseInt(countEmple) == 1) {
                $.ajax({
                    url: "",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function (data) {
                        if (data.success) {
                            document.getElementById('countEmpleados').textContent = data.total;
                        } else {
                            document.getElementById('countEmpleados').textContent = "0";
                        }
                    },
                    error: function () {
                        toast_error("Error en la solicitud AJAX.");
                    }
                });
            }
        }

        function consultaPersonas() {
            var total = 0
            if (parseInt(countPersona) == 1) {
                $.ajax({
                    url: "{% url 'administrativo:consultaPersonas' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function (data) {
                        if (data.success) {
                            document.getElementById('countPersonas').textContent = data.total;
                        } else {
                            document.getElementById('countPersonas').textContent = "0";
                        }
                    },
                    error: function () {
                        toast_error("Error en la solicitud AJAX.");
                    }
                });
            }
        }

        function consultaMarcadas() {
            var total = 0
            if (parseInt(countMarcadas) == 1) {
                $.ajax({
                    url: "",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function (data) {
                        if (data.success) {
                            document.getElementById('countMarcadas').textContent = data.total;
                        } else {
                            document.getElementById('countMarcadas').textContent = "0";
                        }
                    },
                    error: function () {
                        toast_error("Error en la solicitud AJAX.");
                    }
                });
            }
        }

        // Llama a la función cada segundo (1000 milisegundos)
        setInterval(consultaAdministrativos, 500);
        setInterval(consultaPersonas, 500);
    </script>
    <style>
        .small-chart {
            width: 22% !important;
            height: 50% !important;
        }
    </style>
{% endblock %}
{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header" style="margin-top: -50px">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Panel Principal</h1>
                </div><!-- /.col -->
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->
    <!-- Dashboard -->

    <div class="container" style="display: flex; flex-wrap: wrap; gap: 1px;">
        <!-- Sección de Gráficas (Redondas y Líneas) -->
        <div class="col-lg-7 col-md-12" style="display: flex; flex-direction: column; flex: 1;">
            <!-- Gráficas Redondas -->
            <div class="row d-flex flex-wrap mb-3">
                <div class="col-lg-4 col-md-4 col-12">
                    <div class="card" style="border-radius: 10%; padding: 15px;">
                        <canvas id="myChart1" style="width: 100%!important;" class="small-chart-"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-12">
                    <div class="card" style="border-radius: 10%; padding: 15px;">
                        <canvas id="myChart2" style="width: 100%!important;" class="small-chart-"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-12">
                    <div class="card" style="border-radius: 10%; padding: 15px;">
                        <canvas id="myChart3" style="width: 100%!important;" class="small-chart-"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gráfica de Líneas -->
            <section class="content">
                <div class="col-lg-12 col-md-12" style="display: flex; flex-direction: column; flex: 1;gap: 10px;">
                    <div class="row d-flex flex-wrap mb-3 justify-content-center">
                        <button id="vacunacionBtn" style="width: 20%;margin-right: 5px" class="btn btn-outline-info"
                                type="button">
                            <i class="bi bi-clipboard-pulse"></i> Vacunación
                        </button>
                        <button id="ctrlMedicoBtn" style="width: 20%;margin-right: 5px" class="btn btn-outline-info"
                                type="button">
                            <i class="bi bi-heart-pulse"></i> Ctrl. Medico
                        </button>
                        <button id="desparacBtn" style="width: 20%;margin-right: 5px" class="btn btn-outline-info"
                                type="button">
                            <i class="bi bi-bandaid"></i> Desparac.
                        </button>
                    </div>
                </div>
                <canvas id="chartGrafica"></canvas>
            </section>
        </div>

        <!-- Tabla a un lado de las gráficas -->
        <div class="col-lg-3 col-md-12" style="flex: 1;width: 40vh">
            <div class="card" style="border-radius: 2%; padding: 15px;width: 70vh">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0 text-center">Citas Para Hoy </h5>
                </div>
                <div class="card-body">
                    <div class="table mb-0 text-nowrap table-responsive" style="width: 100%;height: 79vh">
                        <table class="table mb-0 text-nowrap " style="width: 100%;height: 79vh">
                            <thead class="table-light">
                            <tr>
                                <th class="border-0">Nombre</th>
                                <th class="border-0">Hora</th>
                                <th class="border-0">Estado</th>

                            </tr>
                            </thead>
                            <tbody>
                            {% for ultimacita in ultimascitas %}
                                <tr>
                                    <td class="align-middle border-bottom-0"
                                        style="word-wrap: break-word; white-space: normal;">
                                        <a class="text-inherit">
                                            <h6 class="mb-0 text-primary-hover">{{ ultimacita.mascota.get_propietario }}</h6>
                                        </a>
                                    </td>
                                    <td class="align-middle border-bottom-0">
                                        {{ ultimacita.hora_cita }}
                                    </td>
                                    <td class="align-middle border-bottom-0">
                                        <a class="btn btn-{{ ultimacita.get_color_estado }}">{{ ultimacita.get_estado_display }}</a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- jQuery -->
    <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
        $.widget.bridge('uibutton', $.ui.button)
    </script>
    <!-- Bootstrap 4 -->
    <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <!-- ChartJS -->
    <script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
    <!-- Sparkline -->
    <script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
    <!-- JQVMap -->
    <script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
    <script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
    <!-- jQuery Knob Chart -->
    <script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
    <!-- daterangepicker -->
    <script src="{% static 'plugins/moment/moment.min.js' %}"></script>
    <script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <!-- Summernote -->
    <script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
    <!-- overlayScrollbars -->
    <script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
    <!-- AdminLTE App -->
    <script src="{% static 'dist/js/adminlte.js' %}"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="{% static 'dist/js/demo.js' %}"></script>
    <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
    <script src="{% static 'dist/js/pages/dashboard.js' %}"></script>
    <script>
        // Obtener los elementos canvas
        const ctx1 = document.getElementById('myChart1').getContext('2d');
        const ctx2 = document.getElementById('myChart2').getContext('2d');
        const ctx3 = document.getElementById('myChart3').getContext('2d');

        // Crear los gráficos
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Perros'],
                datasets: [{
                    data: [25],
                    backgroundColor: ['#DC3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                cutout: '80%' // Tamaño del agujero en el gráfico
            },
            plugins: [
                {
                    id: 'centerText',
                    beforeDraw(chart) {
                        const {width} = chart;
                        const {height} = chart;
                        const ctx = chart.ctx;

                        ctx.save();

                        // Calcular posición del centro
                        const text = `${chart.data.datasets[0].data[0]}`; // Dinámico: toma el valor del primer dato
                        const fontSize = (height / 8).toFixed(2); // Ajusta el tamaño de la fuente
                        ctx.font = `${fontSize}px Arial`;
                        ctx.fillStyle = '#000000'; // Color del texto
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        const centerX = width / 2;
                        const centerY = height / 2.2;

                        ctx.fillText(text, centerX, centerY); // Dibuja el texto en el centro

                        ctx.restore();
                    }
                }
            ]
        });

        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Gatos'],
                datasets: [{
                    data: [79],
                    backgroundColor: ['#28A745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                cutout: '80%' // Tamaño del agujero en el gráfico
            },
            plugins: [
                {
                    id: 'centerText',
                    beforeDraw(chart) {
                        const {width} = chart;
                        const {height} = chart;
                        const ctx = chart.ctx;

                        ctx.save();

                        // Calcular posición del centro
                        const text = `${chart.data.datasets[0].data[0]}`; // Dinámico: toma el valor del primer dato
                        const fontSize = (height / 8).toFixed(2); // Ajusta el tamaño de la fuente
                        ctx.font = `${fontSize}px Arial`;
                        ctx.fillStyle = '#000000'; // Color del texto
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        const centerX = width / 2;
                        const centerY = height / 2.2;

                        ctx.fillText(text, centerX, centerY); // Dibuja el texto en el centro

                        ctx.restore();
                    }
                }
            ]
        });

        new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['Otros'],
                datasets: [{
                    data: [52],
                    backgroundColor: ['#F4DB05']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                cutout: '80%' // Tamaño del agujero en el gráfico
            },
            plugins: [
                {
                    id: 'centerText',
                    beforeDraw(chart) {
                        const {width} = chart;
                        const {height} = chart;
                        const ctx = chart.ctx;

                        ctx.save();

                        // Calcular posición del centro
                        const text = `${chart.data.datasets[0].data[0]}`; // Dinámico: toma el valor del primer dato
                        const fontSize = (height / 8).toFixed(2); // Ajusta el tamaño de la fuente
                        ctx.font = `${fontSize}px Arial`;
                        ctx.fillStyle = '#000000'; // Color del texto
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        const centerX = width / 2;
                        const centerY = height / 2.2;

                        ctx.fillText(text, centerX, centerY); // Dibuja el texto en el centro

                        ctx.restore();
                    }
                }
            ]
        });

        // Datos de ejemplo
        const data = {
            labels: ['Agosto', 'Septiembre', 'Octubre', 'Noviembre'],
            datasets: [{
                label: 'Vacunaciones',
                data: [1, 3, 6, 3],
                fill: true,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)'
            }]
        };

        // Configuración del gráfico
        const config = {
            type: 'line',
            data: data,
            options: {}
        };

        // Crear el gráfico
        const myChart = new Chart(
            document.getElementById('chartGrafica'),
            config
        );


        // ...
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Variables globales
        let chart; // Referencia al gráfico
        const ctx = document.getElementById('chartGrafica').getContext('2d');

        // Función para inicializar el gráfico
        function initializeChart(data, labels) {
            if (chart) {
                chart.destroy(); // Destruir gráfico existente si existe
            }

            chart = new Chart(ctx, {
                type: 'bar', // Puedes cambiar el tipo a 'line', 'pie', etc.
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Datos',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función para obtener datos del servidor
        async function fetchData(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Error en la consulta');
                const result = await response.json();
                // Se asume que la respuesta tiene formato { data: [...], labels: [...] }
                return result;
            } catch (error) {
                console.error(error);
                alert('Hubo un error al consultar los datos.');
            }
        }

        // Asociar eventos a los botones
        document.getElementById('vacunacionBtn').addEventListener('click', async () => {
            const data = await fetchData("{% url 'administrativo:vacunacion_data' %}"); // Reemplaza con tu endpoint
            if (data) initializeChart(data.data, data.labels);
        });

        document.getElementById('ctrlMedicoBtn').addEventListener('click', async () => {
            const data = await fetchData("{% url 'administrativo:controlmedico_data' %}");
            if (data) initializeChart(data.data, data.labels);
        });

        document.getElementById('desparacBtn').addEventListener('click', async () => {
            const data = await fetchData("{% url 'administrativo:desparasitacion_data' %}");
            if (data) initializeChart(data.data, data.labels);
        });
    </script>
{% endblock %}
